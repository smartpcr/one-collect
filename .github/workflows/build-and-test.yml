name: Build and Test

permissions:
  contents: read

on:
  workflow_call:
    inputs:
      os:
        required: true
        type: string
        description: 'Operating system (ubuntu-latest, windows-latest)'
      container:
        required: false
        type: string
        description: 'Container image (e.g., rust:alpine)'
      setup-command:
        required: false
        type: string
        description: 'Setup command to run before checkout (e.g., apk add --no-cache musl-dev)'
      build-flavor:
        required: true
        type: string
        description: 'Build flavor (debug or release)'
      platform-name:
        required: true
        type: string
        description: 'Platform name for display (e.g., Linux-glibc-x64, Windows-x64)'

jobs:
  build-and-test:
    name: Build and Test (${{ inputs.build-flavor == 'release' && 'Release' || 'Debug' }}/${{ inputs.platform-name }})
    runs-on: ${{ inputs.os }}
    container: ${{ inputs.container || null }}

    steps:
    - name: Setup environment
      if: ${{ inputs.setup-command != '' }}
      run: ${{ inputs.setup-command }}
    
    - uses: actions/checkout@v3
    
    - name: 'one_collect: Build'
      working-directory: one_collect
      run: cargo build ${{ inputs.build-flavor == 'release' && '--release' || '' }} --verbose
    
    - name: 'one_collect: Run tests'
      working-directory: one_collect
      run: cargo test ${{ inputs.build-flavor == 'release' && '--release' || '' }} --verbose
    
    - name: 'ruwind: Build'
      working-directory: ruwind
      run: cargo build ${{ inputs.build-flavor == 'release' && '--release' || '' }} --verbose
    
    - name: 'ruwind: Run tests'
      working-directory: ruwind
      run: cargo test ${{ inputs.build-flavor == 'release' && '--release' || '' }} --verbose
    
    - name: 'record-trace executable: Build'
      working-directory: record-trace
      run: cargo build ${{ inputs.build-flavor == 'release' && '--release' || '' }} --verbose
    
    - name: 'record-trace executable: Run tests'
      working-directory: record-trace
      run: cargo test ${{ inputs.build-flavor == 'release' && '--release' || '' }} --verbose
    
    - name: 'record-trace FFI: Build'
      working-directory: record-trace/ffi
      run: cargo build ${{ inputs.build-flavor == 'release' && '--release' || '' }} --verbose
    
    - name: 'record-trace FFI: Run tests'
      working-directory: record-trace/ffi
      run: cargo test ${{ inputs.build-flavor == 'release' && '--release' || '' }} --verbose
